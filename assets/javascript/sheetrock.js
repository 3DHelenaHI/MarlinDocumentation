/*!
 * Sheetrock v1.0.1
 * Quickly connect to, query, and lazy-load data from Google Sheets.
 * http://chriszarate.github.io/sheetrock/
 * License: MIT
 */
!function(e,t){"use strict";var r=t();"function"==typeof define&&define.amd?define("sheetrock",function(){return r.environment.amd=!0,r}):"object"==typeof module&&module.exports?(r.environment.commonjs=!0,r.environment.request=require("request"),module.exports=r):e.sheetrock=r}(this,function(){"use strict";var e={2014:{apiEndpoint:"https://docs.google.com/spreadsheets/d/%key%/gviz/tq?",keyFormat:new RegExp("spreadsheets/d/([^/#]+)","i"),gidFormat:new RegExp("gid=([^/&#]+)","i")},2010:{apiEndpoint:"https://spreadsheets.google.com/tq?key=%key%&",keyFormat:new RegExp("key=([^&#]+)","i"),gidFormat:new RegExp("gid=([^/&#]+)","i")}},t={loaded:{},failed:{},labels:{},header:{},offset:{}},r=0,n="undefined"==typeof window?{}:window,o={document:n.document||{},dom:!(!n.document||!n.document.createElement),jquery:!!(n.jQuery&&n.jQuery.fn&&n.jQuery.fn.jquery),request:!1};Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,r=this,n=r.length;for(t=0;n>t;t+=1)e(r[t],t)}),Array.prototype.map||(Array.prototype.map=function(e){var t=this,r=[];return t.forEach(function(t,n){r[n]=e(t,n)}),r}),Object.keys||(Object.keys=function(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&r.push(t);return r});var a=function(e,r,n){if(e instanceof Error||(e=new Error(e)),r&&r.request&&r.request.index&&(t.failed[r.request.index]=!0),!(r&&r.user&&r.user.callback))throw e;r.user.callback(e,r,n||null)},u=function(e){return e.toString().replace(/^ +/,"").replace(/ +$/,"")},s=function(e){return Math.max(0,parseInt(e,10)||0)},i=function(e,t){var r=" "+e.className+" ";return-1!==r.indexOf(" "+t+" ")},c=function(e){return e=e||{},e.jquery&&e.length&&(e=e[0]),e.nodeType&&1===e.nodeType?e:!1},f=function(){o.dom=!(!o.document||!o.document.createElement)},l=function(t){var r={},n=Object.keys(e);return n.forEach(function(n){var o=e[n];o.keyFormat.test(t)&&o.gidFormat.test(t)&&(r.key=t.match(o.keyFormat)[1],r.gid=t.match(o.gidFormat)[1],r.apiEndpoint=o.apiEndpoint.replace("%key%",r.key))}),r},d=function(e){return e.key&&e.gid?e.key+"_"+e.gid+"_"+e.query:null},m=function(e){var t;return t=e&&e.f?e.f:e&&e.v?e.v:"",t instanceof Array&&(t=e.f||t.join("")),u(t)},h=function(e,t,r){var n={cells:{},cellsArray:t,labels:r,num:e};return t.forEach(function(e,t){n.cells[r[t]]=e}),n},p=function(e,t){return"<"+t+">"+e+"</"+t+">"},y=function(e){var t=e.num?"td":"th",r=Object.keys(e.cells),n="";return r.forEach(function(r){n+=p(e.cells[r],t)}),p(n,"tr")},v=function(e){t.loaded[e]=!1,t.failed[e]=!1,t.labels[e]=!1,t.header[e]=0,t.offset[e]=0},b=function(e,t){var r={},n=Object.keys(e);return t.query=t.sql||t.query,t.reset=t.resetStatus||t.reset,t.fetchSize=t.chunkSize||t.fetchSize,t.rowTemplate=t.rowHandler||t.rowTemplate,n.forEach(function(n){r[n]=t[n]||e[n]}),r},g=function(e,t){return t.target=c(t.target)||c(e),t.fetchSize=s(t.fetchSize),t},q=function(e,r){var n=g(e,r),o=l(n.url);return o.query=n.query,o.index=d(o),n.reset&&o.index&&(v(o.index),o.reset=!0),n.offset=t.offset[o.index]||0,n.fetchSize&&o.index&&(o.query+=" limit "+(n.fetchSize+1),o.query+=" offset "+n.offset,t.offset[o.index]=n.offset+n.fetchSize),{user:n,request:o}},k=function(e){if(!e.user.target&&!e.user.callback)throw"No element targeted or callback provided.";if(!e.request.key||!e.request.gid)throw"No key/gid in the provided URL.";if(t.failed[e.request.index])throw"A previous request for this resource failed.";if(t.loaded[e.request.index])throw"No more rows to load!";return e},w=function(e,t){return e&&e.length===t.length?e:t},E=function(e,r){var n=e.request.index,o=t.labels[n],a=e.user.fetchSize,u=r.table.rows,s=r.table.cols,i={last:u.length-1,rowNumberOffset:t.header[n]||0};return e.user.offset||(o=s.map(function(e,t){return e.label?e.label.replace(/\s/g,""):(i.last=i.last+1,i.rowNumberOffset=1,m(u[0].c[t]).replace(/\s/g,"")||e.id)}),t.offset[n]=t.offset[n]+i.rowNumberOffset,t.header[n]=i.rowNumberOffset,t.labels[n]=o),(!a||u.length-i.rowNumberOffset<a)&&(i.last=i.last+1,t.loaded[n]=!0),i.labels=w(e.user.labels,o),i},x=function(e,t,r){var n=[],o=t.labels;return e.offset||t.rowNumberOffset||n.push(h(0,o,o)),r.table.rows.forEach(function(r,a){if(r.c&&a<t.last){var u=s(e.offset+a+1-t.rowNumberOffset);n.push(h(u,r.c.map(m),o))}}),n},j=function(e,t,r){if("TABLE"===e.tagName){var n=o.document.createElement("thead"),a=o.document.createElement("tbody");n.innerHTML=t,a.innerHTML=r,e.appendChild(n),e.appendChild(a)}else e.insertAdjacentHTML("beforeEnd",t+r)},N=function(e,t){var r=e.rowTemplate||y,n=o.dom&&e.target,a=n&&"TABLE"===e.target.tagName,u=n&&i(e.target,"sheetrock-header"),s="",c="";return t.forEach(function(e){e.num?c+=r(e):(a||u)&&(s+=r(e))}),n&&j(e.target,s,c),a?p(s,"thead")+p(c,"tbody"):s+c},O=function(e,t){var r={raw:t};try{var n=r.attributes=E(e,t),o=r.rows=x(e.user,n,t);r.html=N(e.user,o)}catch(u){return void a("Unexpected API response format.",e,r)}e.user.callback&&e.user.callback(null,e,r)},S=function(e,t){if("function"!=typeof o.request)throw"No HTTP transport available.";var r={headers:{"X-DataSource-Auth":"true"},url:e.request.url},n=function(r,n,o){if(r||200!==n.statusCode)a(r||"Request failed.",e);else try{o=JSON.parse(o.replace(/^\)\]\}\'\n/,"")),t(e,o)}catch(u){a(u,e,{raw:o})}};o.request(r,n)},T=function(e,t){var u,s,i,c=o.document.getElementsByTagName("head")[0],f=o.document.createElement("script"),l="_sheetrock_callback_"+r;u=function(){f.removeEventListener&&(f.removeEventListener("error",i,!1),f.removeEventListener("abort",i,!1)),c.removeChild(f),delete n[l]},s=function(r){try{t(e,r)}catch(n){a(n,e,{raw:r})}finally{u()}},i=function(){a("Request failed.",e),u()},n[l]=s,e.request.url=e.request.url.replace("%callback%",l),f.addEventListener&&(f.addEventListener("error",i,!1),f.addEventListener("abort",i,!1)),f.type="text/javascript",f.src=e.request.url,c.appendChild(f),r+=1},A=function(e){var t=["gid="+encodeURIComponent(e.request.gid),"tq="+encodeURIComponent(e.request.query)];return o.dom&&t.push("tqx=responseHandler:%callback%"),e.request.apiEndpoint+t.join("&")},L=function(e,t){e.request.url=A(e),o.dom?T(e,t):S(e,t)},z={url:"",query:"",target:null,fetchSize:0,labels:[],rowTemplate:null,callback:null,reset:!1},R=function(e,t){try{e=b(z,e||{}),e=q(this,e),e=k(e),f(),t?O(e,t):L(e,O)}catch(r){a(r,e)}return this};return R.defaults=z,R.version="1.0.1",R.environment=o,o.jquery&&(n.jQuery.fn.sheetrock=R),R});