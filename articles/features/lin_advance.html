<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Linear Advance extrusion algorithm - Marlin 3D Printer Firmware</title><meta property="og:title" content="Linear Advance extrusion algorithm"><meta name="description" content="A nozzle pressure control feature for improved print quality"><meta property="og:description" content="A nozzle pressure control feature for improved print quality"><link rel="canonical" href="http://marlinfw.org/articles/features/lin_advance.html"><meta property="og:url" content="http://marlinfw.org/articles/features/lin_advance.html"><meta property="og:site_name" content="Marlin 3D Printer Firmware"><meta property="og:type" content="article"><meta property="article:published_time" content="2016-07-01T09:30:14+01:00"><link rel="next" href="http://marlinfw.org/articles/getting-started/" title=""><link rel="prev" href="http://marlinfw.org/articles/features/" title=""> <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Linear Advance extrusion algorithm",
    "datePublished": "2016-07-01T09:30:14+01:00",
    "description": "A nozzle pressure control feature for improved print quality",
    "logo": "http://marlinfw.org/assets/images/logo/marlin/small.png",
    "url": "http://marlinfw.org/articles/features/lin_advance.html"
  }
</script><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="/assets/stylesheets/bootstrap.min.css"> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--><script src="/assets/javascript/head.min.js"></script><script>var domains=["www.marlinfw.org","marlinfw.org","localhost","127.0.0.1"],pathname=location.pathname.replace(/^\/MarlinDocumentation/,"");-1==domains.indexOf(window.location.hostname)&&(window.top.location.href="http://www.marlinfw.org"+pathname),head.load("/assets/stylesheets/font-awesome.min.css","/assets/stylesheets/syntax.css","/assets/stylesheets/custom.css","/assets/javascript/jquery-2.2.1.min.js","/assets/javascript/jquery-ui.min.js","/assets/javascript/bootstrap.min.js","/assets/javascript/tocify.min.js","/assets/javascript/custom.js","/assets/javascript/holder.min.js","/assets/javascript/sheetrock.min.js","/assets/javascript/cookieconsent.min.js"),head.ready(function(){window.cookieconsent_options={message:"We uses cookies to ensure you get the best experience on our website",dismiss:"Got it!",learnMore:"More info",link:"",theme:"dark-bottom"}})</script></head><body role="document"> <nav class="navbar navbar-default navbar-fixed-top custom-no-margin"><div class="container"><div class="navbar-header"> <a href="/" class="navbar-brand"> <img src="/assets/images/logo/marlin/text.png" alt="Marlin" height="25"> </a> <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button></div><div class="navbar-collapse collapse" id="navbar-main"><ul class="nav navbar-nav"><li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="navbar-getting-started"> Getting Started <span class="caret"></span></a><ul class="dropdown-menu"><li> <a href="/articles/getting-started/overview.html"> Introduction</a></li><li class="divider"></li><li> <a href="#"> <del>How to get</del></a></li><li> <a href="/articles/development/configuration.html"> How to configure</a></li><li> <a href="/articles/getting-started/install.html"> How to flash your board</a></li><li class="divider"></li><li> <a href="/articles/development/reporting-bugs.html"> Reporting bugs</a></li></ul></li><li> <a href="/download/"> Download</a></li><li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="navbar-documentation"> Documentation <span class="caret"></span></a><ul class="dropdown-menu"><li> <a href="/articles/development/changelog.html"> Changelog</a></li><li class="divider"></li><li> <a href="#"> <del>Current stable release</del></a></li><li> <a href="#"> <del>Current development release</del></a></li><li class="divider"></li><li> <a href="/meta/needs-review/"> Documentation needing review</a></li></ul></li><li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="navbar-development"> Development <span class="caret"></span></a><ul class="dropdown-menu"><li> <a href="/articles/development/contributing.html"> Contributing</a></li><li> <a href="/articles/development/coding-standards.html"> Coding standards</a></li><li class="divider"></li><li> <a href="https://github.com/MarlinFirmware/Marlin/issues"> Bugtracker</a></li><li> <a href="/articles/development/reporting-bugs.html"> Reporting bugs</a></li><li class="divider"></li><li> <a href="https://github.com/MarlinFirmware/Marlin/"> Source code repository</a></li><li class="divider"></li><li> <a href="/tools/u8glib/converter.html"> C/C++ bitmap converter</a></li></ul></li></ul><ul class="nav navbar-nav navbar-right visible-lg-block"><li> <a href="https://github.com/MarlinFirmware/MarlinDocumentation/edit/master/_articles/features/lin_advance.md" data-proofer-ignore> <i class="fa fa-pencil-square-o" aria-hidden="true"></i> <span class="">Improve this page</span></a></li></ul></div></div> </nav> <nav><div class="container custom-no-padding"><div class="row"><div class="col-lg-12 visible-lg-block visible-md-block custom-no-margin"><ol class="breadcrumb custom-no-margin"><li> <a href="/"> <i class="glyphicon glyphicon-home"></i></a></li><li><a href="/articles/">Articles</a></li><li><a href="/articles/features/">Features</a></li><li class="active">Linear Advance extrusion algorithm</li></ol></div></div></div> </nav><div class="container" role="main"><div class="row"><div class="col-lg-3 col-md-4 visible-lg-block visible-md-block custom-no-padding"><div class="custom-fixed-sidebar"><div id="toc"></div></div></div><div class="col-lg-9 col-md-8 custom-bg-white"><div class="row"><div class="col-md-12 custom-article"><p class="text-right pull-right visible-lg-block hidden-print small custom-pt25"> <a href="https://github.com/Sebastianv650" data-toggle="tooltip" data-placement="bottom" title="Visit Sebastianv650's profile on Github"><img class="avatar avatar-small" src="https://avatars1.githubusercontent.com/Sebastianv650?v=3&amp;s=30" alt="Sebastianv650" srcset="https://avatars1.githubusercontent.com/Sebastianv650?v=3&amp;s=30 1x, https://avatars1.githubusercontent.com/Sebastianv650?v=3&amp;s=60 2x, https://avatars1.githubusercontent.com/Sebastianv650?v=3&amp;s=90 3x, https://avatars1.githubusercontent.com/Sebastianv650?v=3&amp;s=120 4x" width="30" height="30" data-proofer-ignore="true"></a></p><h1 class="custom-article-header">Linear Advance extrusion algorithm</h1><hr><h2 id="purpose">Purpose</h2><p>Let’s take the common test cube as an example: You may have noticed that the corners are not sharp, they are bleeding out. Also the top solid infill has some roughness where it comes to print direction changes on the perimeters. These problems are minor at very low print speeds and become much more noticeable when you try to print fast.</p><p>The root cause of this print quality issues is an improper pressure inside the nozzle. In a nutshell, <strong>LIN_ADVANCE</strong> enables a pressure control feature which sets the pressure inside the nozzle to the needed one according to the print speed. This way, bleeding edges and rough solid infill can be nearly eliminated.</p><h2 id="advantages">Advantages</h2><ul><li>Higher dimensional precision due to reduced bleeding edges.</li><li>Higher print speeds are possible without loosing print quality.</li><li>With same print speed, visual and feelable print quality will be increased.</li><li>High acceleration and jerk values are not longer needed to get sharp edges.</li></ul><h2 id="important-notes-before-using">Important notes before using</h2><p>Please consider the following points before you enable pressure control or you may end up with strange and hard to trace back issues:</p><ul><li>Your printer has to produce good prints before. For example, your extruder steps/mm value has to be calibrated precisely - do this at a low print speed like 20 mm/s to keep nozzle pressure effects low in this step! Don’t enable a new feature if you have unresolved issues!</li><li>Check the play in your extruder drive gears (if you have any). Excessive play will lead to strange noises during the extra extruder movements!</li><li>Some slicers have options to control the nozzle pressure in some ways. Common names are: <strong>Pressure advance</strong>, <strong>Coast at end</strong>, <strong>extra restart length after retract</strong>. Disable them all! The firmware will do a much better job than the best slicer can do, and they would influence themselves in a bad way. I also strongly recommend to disable further features like wipe while retract. You can try to enable it again after you have calibrated your <code class="highlighter-rouge">K</code> factor (see next step), but I guess you don’t need it anymore.</li><li>After you have a calibrated, working pressure advance feature, you may want to recheck your retraction distance. You will find out that you can cut it down to nearly 0. This is caused by the pressure control, it reduces the nozzle pressure at the and of a line to about zero. For example, I was using 1 mm retract length for PLA, with enabled <strong>LIN_ADVANCE</strong> I’m now using 0.5 mm.</li><li>Keep in mind that enabling this feature will add extra load to the processor and also your extruder hardware. I recommend to stay at 115200 baud communication speed, specially if you get error messages in your print host software or you get wired movements of your print head. Ensure your print host software is using line numbers and checksums, this is disabled by default in Simplify3D.</li><li>On the extruder side, the needed extra movements may lead to an increased wear on the printed gears of a gregs wade extruder.</li><li>Most testing of this new feature was done on direct drive extruder printers. If you have problems with <a href="http://reprap.org/wiki/Erik%27s_Bowden_Extruder">bowden</a> printers due to the needed high <code class="highlighter-rouge">K</code> values, please report them on Marlin GitHub and/or try to reduce your acceleration value.</li><li>Using this feature with very flexible filaments like Ninjaflex is untested and will most likely not work due to the extremely high needed <code class="highlighter-rouge">K</code> values.</li></ul><h2 id="calibrating">Calibrating</h2><p>For a gregs wade extruder you can use <code class="highlighter-rouge">K = 75</code> as a start point for PLA and <code class="highlighter-rouge">K = 150</code> for nGen. <code class="highlighter-rouge">K</code> is a unique value for an extruder with one filament material. If you are using different filament materials like PLA and ABS, you will have one <code class="highlighter-rouge">K</code> value per material. The value will be higher for more flexible filaments.</p><p>Use a test cube with the dimensions 25x25x2mm for testing. Set the acceleration of your printer to a low value like 500mm/s² to eliminate other effects like overshooting fluid filament on direction changes. Set all print speeds for the cube to the same high value, 70mm/s for 0.2mm layer height for example - but be sure to not exceed the flow rate your hotend can handle! Ensure your slicers cooling settings will not slow down the print speed. If it would do this, disable the cooling feature or increase the length and width of the test cube.</p><p>Print some test cubes, each with another <code class="highlighter-rouge">K</code> value. You can set the value with “M905 <code class="highlighter-rouge">K</code>..” before you start the print, where .. is the value you want it to be. Start with K0 to disable the pressure control, which will give you a reference print how your cube would look like without the feature enabled. Then increase <code class="highlighter-rouge">K</code> maybe in 25 units steps. On every print note down the used <code class="highlighter-rouge">K</code> value.</p><p>The best value is the one where you have no bleeding edges (bleeding edges = <code class="highlighter-rouge">K</code> too low) and no inward rounded edges (<code class="highlighter-rouge">K</code> too high). Check by holding a metal ruler on each of the 4 sides of the test prints. You will also see and even more feel the difference in the quality of the top infill, where it changes print direction at the perimeters. But top infill alone is no sufficient calibration criterion as it is also influenced by the infill overlap % that’s between 15-20% in most slicers.</p><p>When you have found a good value, there are two ways to make them permanent in your firmware. If you are using only one filament material, the best way is to set the <code class="highlighter-rouge">K</code> value inside Configuration_adv.h and reflash the firmware. If you are using different materials, you might want to insert a “M905 <code class="highlighter-rouge">K</code>..” line into the start code inside your slicer profile used for the corresponding material.</p><h1 id="developer-information">Developer information</h1><p>The force needed to move the filament through the nozzle depends on the speed you are trying to push it through. If you push it fast (=printing fast), the filament will be compressed in a first step before the pressure inside the nozzle is high enough to extruder the required amount of material. If you take a single, fast printed line, this results in under extrusion at the line start point (the filament gets compressed, but needed pressure isn’t reached) and over extrusion with a blob at the lines end (the filament is still compressed when the nozzle comes to the stop which results in oozing). For a complete print, this leads to bleeding edges at corners (corners are stop/end points of lines) and in extreme cases even gaps between perimeters due to under extrusion at their start points.</p><p>The <strong>LIN_ADVANCE</strong> pressure control handles this free filament length as a spring, where <code class="highlighter-rouge">K</code> is a spring constant. When the nozzle starts to print a line, it takes the extrusion speed as a reference. Additional to the needed extrusion length for a line segment, which is defined by the slicer, it calculates the needed extra compression of the filament to reach the needed nozzle pressure so that the extrusion length defined by the slicer is really extruded. This is done in every loop of the stepper ISR. During deceleration, the filament compression is released again by the same formula: advance_steps = delta_extrusion_speed * <code class="highlighter-rouge">K</code>. During deceleration, delta_extrusion_speed is negative therefore the advance_steps values is negative which leads to a retract movement relaxing the filament again.</p><p>The basic formula (<code class="highlighter-rouge">advance_steps = delta_extrusion_speed * K</code>) is the same as in the famous JKN pressure control, but with one important difference: JKN is calculating the sum of all needed advance extruder steps inside the planner loop and distributes them equally over every acceleration and deceleration stepper ISR loop. This leads to a wrong distribution of the advance steps, resulting in a not perfect print result. <strong>LIN_ADVANCE</strong> is calculating the needed extra steps on the fly in every stepper ISR loop, therefore executing the needed steps precisely where needed. For further details and graphs have a look into <a href="https://drive.google.com/file/d/0B5UvosQgK3adaHVtdUI5OFR3VUU/view">this presentation, slides 7-9</a>.</p><p>Inside the Marlin code, stepper and planner files are the ones where the work is done. Inside the planner loop, <strong>LIN_ADVANCE</strong> checks if a move needs pressure control. This is true for a print move, but false for travel moves and extruder only moves like retract and prime events. Inside the stepper file, <strong>LIN_ADVANCE</strong> calculates the amount of needed extra steps to reach the needed nozzle pressure inside the stepper ISR. To avoid missing steps, it’s not executing the steps at once. Instead, I reused and modified the extruder stepper ISR implemented with the old Marlin ADVANCE feature. The normal extruder steps are executed together with the extra steps due to <strong>LIN_ADVANCE</strong> in the given time frame before the next stepper ISR loop will fire.</p><p>At the moment, there is no check if the extruder acceleration, speed or jerk will exceed the limits set inside Configuration.h. To achieve such checks, the planner needs to be completely rewritten because a variable acceleration rate is needed to compensate too fast pressure advance movements. I’m quite sure the power of the used ATMega isn’t sufficient to do this.. But up to now, I don’t know about problems according to this in real world printing.</p></div></div></div></div></div> <footer><div class="container"><div class="row"><div class="col-lg-12"><hr></div></div><div class="row"><div class="col-lg-8"><p>Brought to you with <i class="fa fa-heart text-danger" aria-hidden="true"></i> lack of <i class="fa fa-bed" aria-hidden="true"></i> and lots of <i class="fa fa-coffee" aria-hidden="true"></i>. <br> The contents of this website are © 2016 under the terms of the <a href="http://www.gnu.org/licenses/gpl-3.0.txt">GPLv3</a> License.</p></div><div class="col-lg-4"><div class="pull-right"> <a href="#top" data-proofer-ignore> Back to top <i class="fa fa-level-up" aria-hidden="true"></i></a></div></div></div></div> </footer> <script>!function(e,a,t,n,s,i,o){e.GoogleAnalyticsObject=s,e[s]=e[s]||function(){(e[s].q=e[s].q||[]).push(arguments)},e[s].l=1*new Date,i=a.createElement(t),o=a.getElementsByTagName(t)[0],i.async=1,i.src=n,o.parentNode.insertBefore(i,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-76230130-1",{cookieDomain:"marlinfw.org",siteSpeedSampleRate:80}),ga("require","displayfeatures"),ga("send","pageview")</script></body></html>